name: Build

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    - name: Collect build info
      id: info
      run: |
        SHA_SHORT=$(git rev-parse --short HEAD)
        echo "sha_short=$SHA_SHORT" >> $GITHUB_OUTPUT
        echo "build_id=${{ github.run_number }}" >> $GITHUB_OUTPUT

    - name: Locate and link game assemblies
      id: check_libs
      run: |
        # Common WSL2 paths for Steam games
        GAME_PATHS=(
          "/mnt/c/Program Files (x86)/Steam/steamapps/common/Travelers Rest/Traveler's Rest_Data/Managed"
          "/mnt/c/Steam/steamapps/common/Travelers Rest/Traveler's Rest_Data/Managed"
          "/mnt/d/SteamLibrary/steamapps/common/Travelers Rest/Traveler's Rest_Data/Managed"
          "$HOME/.steam/steam/steamapps/common/Travelers Rest/Traveler's Rest_Data/Managed"
        )
        
        FOUND_PATH=""
        for path in "${GAME_PATHS[@]}"; do
          if [ -f "$path/Assembly-CSharp.dll" ]; then
            FOUND_PATH="$path"
            echo "✅ Found game assemblies at: $path"
            break
          fi
        done
        
        if [ -n "$FOUND_PATH" ]; then
          mkdir -p libs
          ln -sf "$FOUND_PATH/Assembly-CSharp.dll" libs/
          ln -sf "$FOUND_PATH/UnityEngine.dll" libs/
          ln -sf "$FOUND_PATH/UnityEngine.CoreModule.dll" libs/
          ln -sf "$FOUND_PATH/UnityEngine.UI.dll" libs/
          ln -sf "$FOUND_PATH/UnityEngine.IMGUIModule.dll" libs/
          echo "has_libs=true" >> $GITHUB_OUTPUT
          echo "✅ Symlinked game assemblies to libs/"
        else
          echo "has_libs=false" >> $GITHUB_OUTPUT
          echo "⚠️  Game assemblies not found in common paths"
          echo "Searched:"
          printf '%s\n' "${GAME_PATHS[@]}"
        fi

    - name: Restore dependencies
      if: steps.check_libs.outputs.has_libs == 'true'
      run: dotnet restore

    - name: Build
      if: steps.check_libs.outputs.has_libs == 'true'
      run: dotnet build --configuration Release --no-restore

    - name: Test
      if: steps.check_libs.outputs.has_libs == 'true'
      run: dotnet test --configuration Release --no-build --verbosity normal || echo "No tests found"

    - name: Package mod
      if: steps.check_libs.outputs.has_libs == 'true'
      run: |
        mkdir -p dist
        cp -r bin/Release/net6.0/*.dll dist/
        cd dist
        zip -r ../TRTracker-dev-${{ steps.info.outputs.sha_short }}.zip .

    - name: Upload artifacts
      if: steps.check_libs.outputs.has_libs == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: TRTracker-dev-${{ steps.info.outputs.sha_short }}-${{ steps.info.outputs.build_id }}
        path: TRTracker-dev-*.zip
